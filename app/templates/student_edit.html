{% extends "base.html" %}

{% block title %}Edit Student - AI Attendance Tracker{% endblock %}

{% block content %}
<div class="form-container">
    <h1>‚úèÔ∏è Edit Student</h1>
    <p class="subtitle">Editing: <strong>{{ student.roll_no }} - {{ student.name }}</strong></p>
    
    <div class="student-preview">
        <h3>Current Information:</h3>
        <div class="preview-grid">
            <div class="preview-item">
                <label>Roll Number:</label>
                <span>{{ student.roll_no }}</span>
            </div>
            <div class="preview-item">
                <label>Name:</label>
                <span>{{ student.name }}</span>
            </div>
            <div class="preview-item">
                <label>Semester:</label>
                <span>{{ student.semester }}</span>
            </div>
            <div class="preview-item">
                <label>Enrolled Since:</label>
                <span>{{ student.created_at.strftime('%Y-%m-%d') if student.created_at else 'N/A' }}</span>
            </div>
        </div>
    </div>
    
    <form method="POST" novalidate>
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.roll_no.label }}
            {{ form.roll_no(class="form-control", placeholder="e.g., CS2021001") }}
            {% if form.roll_no.errors %}
                <div class="error-msg">{{ form.roll_no.errors[0] }}</div>
            {% endif %}
            <small class="form-text">‚ö†Ô∏è Changing roll number requires uniqueness check</small>
        </div>
        
        <div class="form-group">
            {{ form.name.label }}
            {{ form.name(class="form-control", placeholder="e.g., John Doe") }}
            {% if form.name.errors %}
                <div class="error-msg">{{ form.name.errors[0] }}</div>
            {% endif %}
            <small class="form-text">Student's full name (3-100 characters)</small>
        </div>
        
        <div class="form-group">
            {{ form.semester.label }}
            {{ form.semester(class="form-control", placeholder="1-8", min="1", max="8") }}
            {% if form.semester.errors %}
                <div class="error-msg">{{ form.semester.errors[0] }}</div>
            {% endif %}
            <small class="form-text">Current semester (1-8)</small>
        </div>
        
        <div class="info-box">
            <h4>‚ÑπÔ∏è Important Notes:</h4>
            <ul>
                <li>Roll number must be unique across all students</li>
                <li>All related attendance and performance records will remain linked</li>
                <li>Changes are logged and timestamped</li>
                <li>AI validation will check data quality</li>
            </ul>
        </div>
        
        <div class="related-data">
            <h4>üìä Related Records:</h4>
            <div class="related-grid">
                <div class="related-item">
                    <span class="related-label">Attendance Records:</span>
                    <span class="related-value">{{ student.attendance_records.count() }}</span>
                </div>
                <div class="related-item">
                    <span class="related-label">Performance Records:</span>
                    <span class="related-value">{{ student.performance_records.count() }}</span>
                </div>
                <div class="related-item">
                    <span class="related-label">Average Marks:</span>
                    <span class="related-value">{{ "%.2f"|format(student.average_marks) }}/100</span>
                </div>
                {% if student.attendance %}
                <div class="related-item">
                    <span class="related-label">Attendance %:</span>
                    <span class="related-value {% if student.attendance.has_shortage %}text-danger{% else %}text-success{% endif %}">
                        {{ "%.2f"|format(student.attendance.attendance_percentage) }}%
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('students.list_students') }}" class="btn btn-secondary">Cancel</a>
            <a href="{{ url_for('students.view_student', id=student.id) }}" class="btn btn-info">üëÅÔ∏è View Details</a>
        </div>
    </form>
    
    <div class="danger-zone">
        <h4>‚ö†Ô∏è Danger Zone</h4>
        <p>Deleting this student will permanently remove all associated records.</p>
        <form method="POST" action="{{ url_for('students.delete_student', id=student.id) }}" 
              onsubmit="return confirm('Are you sure you want to delete {{ student.name }}? This will also delete:\n- {{ student.attendance_records.count() }} attendance record(s)\n- {{ student.performance_records.count() }} performance record(s)\n\nThis action cannot be undone!');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">üóëÔ∏è Delete Student</button>
        </form>
    </div>
</div>

<style>
.student-preview {
    background: var(--bg-color);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    border-left: 4px solid var(--primary-color);
}

.student-preview h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.preview-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.preview-item label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.preview-item span {
    font-size: 1.125rem;
    font-weight: 500;
}

.info-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    margin: 1.5rem 0;
    border-radius: 4px;
}

.info-box h4 {
    margin-top: 0;
    color: #1976d2;
}

.info-box ul {
    margin: 0.5rem 0 0 1.5rem;
}

.info-box li {
    margin-bottom: 0.5rem;
}

.related-data {
    background: var(--bg-color);
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
}

.related-data h4 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.related-item {
    background: var(--card-bg);
    padding: 1rem;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.related-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.related-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--primary-color);
}

.danger-zone {
    margin-top: 3rem;
    padding: 1.5rem;
    border: 2px solid #f44336;
    border-radius: 8px;
    background: #ffebee;
}

.danger-zone h4 {
    margin-top: 0;
    color: #c62828;
}

.danger-zone p {
    color: #c62828;
    margin-bottom: 1rem;
}

body.dark-theme .info-box {
    background: #1a3a52;
}

body.dark-theme .danger-zone {
    background: #3d1a1a;
    border-color: #f44336;
}

body.dark-theme .danger-zone h4,
body.dark-theme .danger-zone p {
    color: #ff6b6b;
}

@media (max-width: 768px) {
    .preview-grid,
    .related-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Form change detection
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="POST"]');
    const inputs = form.querySelectorAll('input[type="text"], input[type="number"]');
    let formChanged = false;
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    form.addEventListener('submit', function() {
        formChanged = false;
    });
});
</script>
{% endblock %}
